name: vm-proxy-auth
arch: amd64
platform: linux
version: ${NFPM_VERSION}
maintainer: edelwud <noreply@yer.sh>
description: VictoriaMetrics Proxy with Authentication and Multi-tenant Support
homepage: https://github.com/edelwud/vm-proxy-auth
license: MIT
section: default
priority: extra

contents:
  - src: vm-proxy-auth
    dst: /usr/bin/vm-proxy-auth
    file_info:
      mode: 0755
  - src: examples/
    dst: /etc/vm-proxy-auth/examples/
    type: tree
  - src: systemd/vm-proxy-auth.service
    dst: /lib/systemd/system/vm-proxy-auth.service
    file_info:
      mode: 0644
  - dst: /var/log/vm-proxy-auth
    type: dir
    file_info:
      mode: 0755
  - dst: /etc/vm-proxy-auth
    type: dir
    file_info:
      mode: 0755

scripts:
  preinstall: >-
    #!/bin/sh

    set -e

    if ! id vm-proxy-auth >/dev/null 2>&1; then
      useradd --system --no-create-home --shell /bin/false vm-proxy-auth 2>/dev/null || true
    fi
  postinstall: >-
    #!/bin/sh

    set -e

    if [ -d "/var/log/vm-proxy-auth" ]; then
      chown -R vm-proxy-auth:vm-proxy-auth /var/log/vm-proxy-auth || true
    fi

    if [ -d "/etc/vm-proxy-auth" ]; then
      chown vm-proxy-auth:vm-proxy-auth /etc/vm-proxy-auth || true
    fi

    if command -v systemctl >/dev/null 2>&1; then
      systemctl daemon-reload || true
      systemctl enable vm-proxy-auth || true
    fi
  preremove: >-
    #!/bin/sh

    set -e

    if command -v systemctl >/dev/null 2>&1; then
      systemctl stop vm-proxy-auth || true
      systemctl disable vm-proxy-auth || true
    fi
  postremove: >-
    #!/bin/sh

    set -e

    if command -v systemctl >/dev/null 2>&1; then
      systemctl daemon-reload || true
    fi

    if id vm-proxy-auth >/dev/null 2>&1; then
      userdel vm-proxy-auth >/dev/null 2>&1 || true
    fi